# This file was generated by chef for <%= @node[:fqdn] %>

require File.join(File.dirname(__FILE__), "config.rb")

Eye.application 'sidekiq' do
  <% if node['eye']['notify'] -%>
  notify <%= node['eye']['notify'] %>
  <% end -%>
  <% @env ||= {} -%>
  env(<%= @env %>)
  working_dir '<%= @dir %>'
  stdall 'log/sidekiq.log'
  clear_env true

  trigger :flapping, times: 5, within: 5.minute, retry_in: 10.minutes
  check :memory, below: 3200.megabytes, every: 30.seconds, times: 5

  stop_on_delete true

  stop_signals [:TERM, 60.seconds, :KILL]

  uid '<%= @uid %>'
  gid '<%= @gid %>'

  num_processes = 2
  num_processes.times do |i|
    process "sidekiq-#{i}" do
      pid_file "tmp/pids/sidekiq-#{i}.pid"
      start_command "<%= @dir %>/bin/sidekiq -C config/sidekiq.yml -e <%= @rails_env %> -i #{i}"
      daemonize true
      start_timeout 20.seconds
    end
  end
end
